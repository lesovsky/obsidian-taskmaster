# Group Visibility Settings

**Статус:** Draft
**Дата:** 2026-02-20

## 1. Контекст и проблема

### Текущая ситуация

В TaskMaster есть 6 фиксированных групп задач: `backlog`, `focus`, `inProgress`, `orgIntentions`, `delegated`, `completed`. Все группы всегда отображаются. Пользователь не может убрать ненужные группы — например, `orgIntentions` используют не все рабочие процессы.

### Цель

Дать пользователю возможность настроить, какие группы показываются на доске, без потери данных и без нарушения автоматизаций.

### Метрики успеха

- Пользователь может скрыть любую группу в 2 клика (настройки доски → тогл)
- Задачи в скрытой группе не теряются и не перемещаются автоматически
- Автоматизации (завершение задачи, переходы статусов) работают независимо от видимости группы

---

## 2. Требования

### Функциональные

- [ ] [FR-1] Пользователь может скрыть/показать любую из 6 групп через настройки доски
- [ ] [FR-2] Настройка видимости задаётся **per-board** — у каждой доски своя конфигурация
- [ ] [FR-3] Скрытая группа не отображается на доске (ни заголовок, ни карточки)
- [ ] [FR-4] Задачи, находящиеся в скрытой группе, остаются в ней — никакого автоматического перемещения
- [ ] [FR-5] Автоматизации (переход в `completed`, переход из `completed` в `inProgress`) срабатывают, даже если целевая группа скрыта
- [ ] [FR-6] Минимум 1 группа должна оставаться видимой — UI не позволяет скрыть последнюю
- [ ] [FR-7] По умолчанию все группы видимы (обратная совместимость)
- [ ] [FR-8] Перетаскивание возможно только между видимыми группами
- [ ] [FR-11] Кнопка «Add task» доступна только у видимых групп; если `backlog` скрыт — задача добавляется через кнопку любой другой видимой группы
- [ ] [FR-9] В секции настроек рядом с названием каждой группы отображается счётчик задач (если > 0)
- [ ] [FR-10] Нажатие Cancel в попапе настроек отменяет все несохранённые изменения видимости

### Нефункциональные

- [ ] [NFR-1] Настройка сохраняется через стандартный `persist()` вместе с данными доски
- [ ] [NFR-2] После миграции `version 3 → 4` у каждого `Board` появляется `hiddenGroups: []`; все группы остаются видимыми, данные задач не изменяются
- [ ] [NFR-3] Переключение видимости не требует перезагрузки плагина — реактивное обновление

---

## 3. User Stories

### US-1: Скрыть ненужную группу

**Как** пользователь, который не использует Org Intentions
**Хочу** скрыть эту группу на доске
**Чтобы** интерфейс был чище и не отвлекал

**Критерии приёмки:**
- В настройках доски есть секция "Видимость групп" со свитчерами для каждой группы
- Рядом с названием группы отображается количество задач в ней (например, `Org Intentions (2)`)
- После выключения свитчера группа `orgIntentions` исчезает с доски
- Задачи, которые были в `orgIntentions`, никуда не переместились
- После включения свитчера обратно задачи снова видны
- Нажатие **Cancel** отменяет все изменения — состояние свитчеров возвращается к исходному

### US-2: Завершить задачу при скрытой группе completed

**Как** пользователь со скрытой группой `completed`
**Хочу** нажать иконку завершения на карточке задачи
**Чтобы** задача пометилась как выполненная и ушла с активного экрана

**Критерии приёмки:**
- Задача помечается `status: completed`, `completedAt` проставляется
- Задача перемещается в группу `completed` (в данных)
- Задача исчезает с видимой части доски (т.к. `completed` скрыта)
- Никакой ошибки или предупреждения не возникает

### US-3: Защита от полного скрытия

**Как** пользователь
**Хочу** иметь хотя бы одну видимую группу
**Чтобы** не получить пустой экран без возможности добавить задачу

**Критерии приёмки:**
- Когда только 1 группа видима, её свитчер задизейблен (`disabled` атрибут на `<input>`)
- На контейнере строки (`<label>` или `<div>`) есть `title` атрибут со значением из ключа `boardSettings.cannotHideLastGroup` (не на `<input>` — там tooltip не показывается)

---

## 4. Границы (Scope)

### В scope

- Управление видимостью групп в `BoardSettingsPopup`
- Per-board хранение (`Board.hiddenGroups: GroupId[]`)
- Миграция данных (version 3 → 4)
- Локализация новых строк (EN + RU)
- Защита от скрытия последней группы

### Вне scope

- Изменение порядка групп
- Переименование групп
- Добавление/удаление групп
- Отдельная страница «Archived» для задач из скрытых групп
- Drag & drop в скрытые группы

---

## 5. Технический дизайн

### Изменения типов (`src/data/types.ts`)

```typescript
export interface Board {
  id: string;
  title: string;
  subtitle: string;
  groups: Record<GroupId, Group>;
  notes: string;
  notesCollapsed: boolean;
  hiddenGroups: GroupId[];   // NEW — список скрытых групп, default: []
}
```

### Defaults (`src/data/defaults.ts`)

```typescript
export function createDefaultBoard(title = 'New board'): Board {
  return {
    // ... existing fields ...
    hiddenGroups: [],   // NEW
  };
}
```

### Миграция (`src/data/migration.ts`)

Текущая версия данных: `3`. Новая версия: `4`.

```typescript
if (version < 4) {
  for (const board of result.boards) {
    if ((board as any).hiddenGroups === undefined) {
      (board as any).hiddenGroups = [];
    }
  }
  result.version = 4;
}
```

**Поведение при миграции:** добавляется `hiddenGroups: []`, все группы остаются видимыми — пользователь не заметит никаких изменений.

### UI: BoardSettingsPopup (`src/ui/BoardSettingsPopup.svelte`)

Добавить новую секцию под полями title/subtitle:

```
┌─────────────────────────────────┐
│ Board Settings                  │
├─────────────────────────────────┤
│ Title: [___________________]    │
│ Description: [______________]   │
├─────────────────────────────────┤
│ Group Visibility                │
│ Backlog (5)          [ON ]      │
│ Focus (1)            [ON ]      │
│ In Progress (3)      [ON ]      │
│ Org Intentions (2)   [OFF]      │
│ Delegated            [ON ]      │
│ Completed (12)       [ON ]      │
├─────────────────────────────────┤
│ [Delete]      [Cancel] [Save]   │
└─────────────────────────────────┘
```

> Счётчик `(N)` отображается только если N > 0. Группы без задач показываются без счётчика.

Логика свитчеров:
- Видимость группы = её ID не содержится в `hiddenGroups`
- Название группы берётся из существующих ключей локализации `group.{id}` (например, `group.orgIntentions`) — новых ключей для названий не нужно
- Счётчик задач = `board.groups[id].taskIds.length`; данные уже есть в пропе `board`, дополнительных пропов не требуется
- Рядом с названием каждой группы показывается количество задач, если > 0: `Org Intentions (2)` (0 — не показываем, просто название)
- При переключении: добавить/убрать ID из локального массива `hiddenGroups`
- Свитчер дизейблится, когда это единственная видимая группа (`visibleCount === 1 && isVisible`) — через `disabled` атрибут на `<input>`; атрибут `title={tr('boardSettings.cannotHideLastGroup')}` ставится на **контейнер строки** (`<label>` или `<div>`), а не на `<input>` — на disabled-элементах tooltip не показывается в браузерах
- Изменения применяются только при нажатии **Save** (не live)
- Нажатие **Cancel** и клик по overlay (`tm-popup-overlay`) одинаково сбрасывают локальный `hiddenGroups` к значению `board.hiddenGroups` на момент открытия попапа — оба вызывают `onClose` без сохранения

Инициализация локального состояния в компоненте:
```typescript
let hiddenGroups: GroupId[] = [...board.hiddenGroups]; // копия, не ссылка
```

Локальная копия создаётся один раз при открытии попапа. Обновление пропа `board` извне пока попап открыт не предусмотрено.

Изменение сигнатуры `onSave`:
```typescript
// было
onSave: (fields: { title: string; subtitle: string }) => void

// стало
onSave: (fields: { title: string; subtitle: string; hiddenGroups: GroupId[] }) => void
```

### Рендеринг: BoardLayout (`src/ui/BoardLayout.svelte`)

Фильтрация групп перед рендером:
```typescript
$: visibleGroupIds = GROUP_IDS.filter(id => !board.hiddenGroups.includes(id));
```

Рендерить `CollapsibleGroup` / `TaskGroup` только для `visibleGroupIds`.

**Кнопка «Add task»:** отображается только у видимых групп — никаких изменений не требуется, т.к. `GroupHeader` рендерится только для видимых групп. Если пользователь скрыл `backlog`, он добавляет задачи через кнопку в любой другой видимой группе. Специальной логики выбора группы по умолчанию нет.

### Drag & Drop (`src/ui/useSortable.ts`)

SortableJS уже привязан к DOM-элементам видимых групп. Скрытые группы просто не существуют в DOM — никаких изменений не требуется.

### Автоматизации (`src/logic/statusTransitions.ts`, `src/stores/dataStore.ts`, `src/data/cleanup.ts`)

Изменений не требуется. Переходы статусов и перемещение `taskIds` работают с данными напрямую, не проверяя видимость групп.

**Автоочистка завершённых задач (`cleanup.ts`):** выполняется при загрузке плагина для группы `completed` по `completedRetentionDays`. Если `completed` скрыта — очистка всё равно срабатывает (работает с данными, а не с DOM). Это ожидаемое поведение: скрытие группы не защищает задачи от удаления по истечении срока хранения.

---

## 6. Локализация

Новые ключи для `src/i18n/en.ts` и `src/i18n/ru.ts`:

| Ключ | EN | RU |
|------|----|----|
| `boardSettings.groupVisibility` | `Group Visibility` | `Видимость групп` |
| `boardSettings.groupVisibilityDesc` | `Show or hide groups on this board` | `Показывать или скрывать группы на этой доске` |
| `boardSettings.cannotHideLastGroup` | `At least one group must be visible` | `Хотя бы одна группа должна быть видима` |

---

## 7. Тестирование

**Основные сценарии:**
- [ ] Скрыть группу → она исчезает с доски, задачи остаются в данных
- [ ] Показать скрытую группу обратно → задачи возвращаются на доску
- [ ] Завершить задачу при скрытой `completed` → задача уходит из видимой группы, без ошибок
- [ ] Перетащить задачу в группу, а затем скрыть её → задача остаётся в этой группе
- [ ] Попытаться скрыть последнюю видимую группу → свитчер задизейблен, `title` показывает пояснение
- [ ] Настройки видимости независимы для разных досок
- [ ] Cancel не применяет изменения; клик по overlay — то же самое
- [ ] Новая установка: все группы видимы по умолчанию

**Миграция:**
- [ ] Данные корректно мигрируются с `version=3`: `hiddenGroups` добавляется как `[]`, все группы видимы
- [ ] Данные с `version=0` или отсутствующим полем — пересоздаются из дефолта, `hiddenGroups: []`

**Счётчик и состояние свитчеров:**
- [ ] Группа с задачами показывает `(N)` рядом с названием
- [ ] Группа без задач показывается без счётчика
- [ ] Многократное переключение свитчеров до Save → итоговое состояние корректно (нет накопленных дублей в `hiddenGroups`)
- [ ] Скрытая группа с `collapsed: true` — после скрытия/показа `collapsed` сохраняется

**Автоматизации и cleanup:**
- [ ] Скрыть `backlog` → `Add task` доступен в другой видимой группе
- [ ] Скрыть `completed` → автоочистка по `completedRetentionDays` при перезагрузке всё равно срабатывает

**Визуальные:**
- [ ] Проверить в light и dark теме

---

## 8. Риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Задачи «потеряются» в скрытой группе | Низкая | Высокое | FR-4: задачи не удаляются, только скрываются; группа восстанавливается включением свитчера |
| Пользователь скроет `completed` и не поймёт, куда уходят задачи | Средняя | Низкое | Принятое поведение: задача завершается и исчезает с экрана — это ожидаемо |
| WIP-лимит скрытой группы превышен, но не виден | Низкая | Низкое | Принятое поведение: пользователь явно скрыл группу, значит не работает с ней |

---

## 9. Открытые вопросы

Нет открытых вопросов.
